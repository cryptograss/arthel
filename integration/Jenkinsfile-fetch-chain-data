pipeline {
    agent any

    environment {
        NODE_VERSION = '23.6.1'
        NVM_DIR = '/var/jenkins_home/.nvm'
        SECRETS_DIR = '/var/jenkins_home/secrets'
        SHARED_DATA_DIR = '/var/jenkins_home/shared'
        CHAIN_DATA_DIR = "${SHARED_DATA_DIR}/chain_data"
    }

    stages {
        stage('Setup') {
            steps {
                sh '''
                    mkdir -p ${CHAIN_DATA_DIR}

                    # Copy .env file from secrets
                    cp ${SECRETS_DIR}/0/.env .env
                    chmod 600 .env

                    # Source NVM and activate Node version
                    . "$NVM_DIR/nvm.sh" --silent
                    nvm use ${NODE_VERSION} --silent

                    # Always install pinned pnpm version for lockfile compatibility
                    npm install -g pnpm@9.15.9

                    pnpm install --no-frozen-lockfile --config.ignore-scripts=false
                '''
            }
        }

        stage('Fetch Chain Data') {
            steps {
                sh '''
                    # Source NVM and activate Node version
                    . "$NVM_DIR/nvm.sh" --silent
                    nvm use ${NODE_VERSION} --silent
                    CHAIN_DATA_OUTPUT_DIR=${CHAIN_DATA_DIR} npm run fetch-chain-data

                    # Copy the data to shared location
                    cp -r output/_prebuild_chain_data/* ${CHAIN_DATA_DIR}/
                    cp src/data/time_data.json ${CHAIN_DATA_DIR}/
                '''
            }
        }
    }

    post {
        success {
            // Touch a file to indicate successful completion
            sh "touch ${CHAIN_DATA_DIR}/.last_fetch_success"
        }
    }
}