{% extends 'shared/layouts/base.njk' %}

{% block title %}Chartifacts Player | Justin Holmes{% endblock %}

{% block main %}
{% include 'partials/bigger-banner.njk' %}

<div class="container text-light long-form" id="content">
    <div class="row">
        <div id="main-column-left" class="col-md-8 semi-transparent-bg">
            <h1 class="container-fluid text-center">Chartifacts Player</h1>
            <p class="text-center">Interactive music player with real-time ensemble visualization</p>

            <div class="chartifacts-main-player" style="margin: 30px 0;">
                <div id="webamp-player" class="webamp-container">
                    Loading chartifacts player...
                </div>
                <div id="parts-chart" class="parts-chart"></div>
                <div id="ensemble-display" class="ensemble-display"></div>
            </div>
        </div>

        <div class="col-md-4 semi-transparent-bg">
            <h2>Available Songs</h2>
            <div class="song-list">
                <div class="song-item" data-song="august">
                    <h3>August</h3>
                    <p>Instrumental piece featuring six-whistle and guitar</p>
                    <button class="btn btn-primary load-song" data-song="august">Load Song</button>
                </div>

                <div class="song-item" data-song="barlows-jig">
                    <h3>Barlow's Jig</h3>
                    <p>Traditional jig arrangement</p>
                    <button class="btn btn-primary load-song" data-song="barlows-jig">Load Song</button>
                </div>

                <div class="song-item" data-song="paint-exchange">
                    <h3>Paint Exchange</h3>
                    <p>Original composition</p>
                    <button class="btn btn-primary load-song" data-song="paint-exchange">Load Song</button>
                </div>

                <div class="song-item" data-song="silver-44">
                    <h3>Silver 44</h3>
                    <p>Bluegrass arrangement</p>
                    <button class="btn btn-primary load-song" data-song="silver-44">Load Song</button>
                </div>
            </div>

            <h2>Playlist Controls</h2>
            <div class="playlist-controls">
                <button class="btn btn-secondary" id="load-all-songs">Load All Songs</button>
                <button class="btn btn-secondary" id="shuffle-playlist">Shuffle</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize main chartifacts player page
window.addEventListener('load', function() {
    // Start with August as default
    loadSong('august');

    // Set up song loading buttons
    document.querySelectorAll('.load-song').forEach(button => {
        button.addEventListener('click', function() {
            const songName = this.dataset.song;
            loadSong(songName);
        });
    });

    // Playlist controls
    document.getElementById('load-all-songs').addEventListener('click', loadAllSongs);
    document.getElementById('shuffle-playlist').addEventListener('click', shufflePlaylist);
});

async function loadSong(songName) {
    try {
        // Fetch song data from the embed page data
        const response = await fetch(`/embed/chartifacts-player/${songName}.html`);
        const text = await response.text();

        // Extract songChartifactsData from the embed page
        const dataMatch = text.match(/window\.songChartifactsData = ({.*?});/s);
        if (dataMatch) {
            const songData = JSON.parse(dataMatch[1]);

            // Initialize or update the player
            if (window.currentPlayer) {
                window.currentPlayer.loadNewSong(songData);
            } else {
                window.currentPlayer = new WebampChartifacts('webamp-player', songData, {
                    embedMode: false,
                    playlistMode: true
                });
            }

            // Update UI to show current song
            document.querySelectorAll('.song-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-song="${songName}"]`).classList.add('active');
        }
    } catch (error) {
        console.error('Error loading song:', error);
    }
}

function loadAllSongs() {
    // TODO: Implement playlist with all songs
    console.log('Loading all songs into playlist...');
}

function shufflePlaylist() {
    // TODO: Implement shuffle
    console.log('Shuffling playlist...');
}
</script>

<style>
/* Fix styling issues */
.chartifacts-main-player {
    position: relative;
    min-height: 500px;
}

.webamp-container {
    position: relative;
    width: 100%;
    max-width: 275px;
    height: auto;
}

.ensemble-display {
    position: absolute;
    top: 120px;
    left: 0;
    right: 0;
    height: 200px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 8px;
    overflow-y: auto;
    font-size: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 10;
}

.parts-chart {
    position: absolute;
    top: 85px;
    left: 280px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    max-width: 150px;
    z-index: 20;
}

.part-box {
    padding: 3px 8px;
    background: #f8f9fa;
    font-size: 16px;
    font-weight: bold;
    color: #666;
    transition: all 0.3s ease;
    border-radius: 2px;
}

.part-box.active {
    padding: 12px 20px;
    background: #000000;
    font-size: 24px;
    color: white;
    border: 1px solid gray;
    z-index: 30;
}

.song-list {
    margin-bottom: 20px;
}

.song-item {
    padding: 15px;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    border-left: 3px solid transparent;
    transition: all 0.3s ease;
}

.song-item.active {
    border-left-color: #007bff;
    background: rgba(0, 123, 255, 0.2);
}

.song-item h3 {
    margin: 0 0 5px 0;
    color: #fff;
}

.song-item p {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #ccc;
}

.playlist-controls {
    margin-top: 20px;
}

.playlist-controls button {
    margin: 5px 0;
    width: 100%;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .parts-chart {
        position: relative;
        left: 0;
        top: 10px;
        max-width: 100%;
    }

    .ensemble-display {
        position: relative;
        top: 10px;
        height: auto;
        max-height: 200px;
    }
}
</style>
{% endblock %}